services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: crm
      POSTGRES_USER: crm
      POSTGRES_PASSWORD: crm
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  synapse-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: synapse
      POSTGRES_USER: synapse
      POSTGRES_PASSWORD: synapse
    volumes:
      - synapse_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U synapse"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  web:
    build: .
    command: >
      sh -c "python manage.py migrate &&
             python manage.py seed_orders &&
             python -m daphne -p 8000 -b 0.0.0.0 --application-close-timeout 30 crm_backend.asgi:application"
    ports:
      - "8000:8000"
    environment:
      - DJANGO_SECRET_KEY=dev
      - DEBUG=1
      - DATABASE_URL=postgresql+psycopg://crm:crm@db:5432/crm
      - CORS_ALLOWED_ORIGINS=http://localhost:3000
      - MEDIA_URL=/uploads/
      - MEDIA_ROOT=/app/media/uploads
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - CHANNELS_REDIS_URL=redis://redis:6379/1
      - MAX_ATTACHMENT_MB=10
    volumes:
      - .:/app
    depends_on:
      - db
      - redis

  celery:
    build: .
    command: celery -A crm_backend worker -l info
    environment:
      - DJANGO_SECRET_KEY=dev
      - DEBUG=1
      - DATABASE_URL=postgresql+psycopg://crm:crm@db:5432/crm
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - CHANNELS_REDIS_URL=redis://redis:6379/1
      - MAX_ATTACHMENT_MB=10
    volumes:
      - .:/app
    depends_on:
      - db
      - redis

  celery-beat:
    build: .
    command: celery -A crm_backend beat -l info
    environment:
      - DJANGO_SECRET_KEY=dev
      - DEBUG=1
      - DATABASE_URL=postgresql+psycopg://crm:crm@db:5432/crm
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - CHANNELS_REDIS_URL=redis://redis:6379/1
      - MAX_ATTACHMENT_MB=10
    volumes:
      - .:/app
    depends_on:
      - db
      - redis

  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./media/uploads:/usr/share/nginx/html/uploads:ro
    depends_on:
      - web

  synapse:
    image: matrixdotorg/synapse:latest
    container_name: synapse
    user: "991:991"  # synapse user/group for proper permissions
    ports:
      - "8008:8008"
      - "8448:8448"
    volumes:
      - synapse_data:/data
      - ./synapse/homeserver.yaml:/data/homeserver.yaml:ro
    environment:
      - SYNAPSE_SERVER_NAME=chat.local
      - SYNAPSE_REPORT_STATS=no
    depends_on:
      synapse-db:
        condition: service_healthy
    restart: unless-stopped
    entrypoint: ["/start.py", "run", "--config-path", "/data/homeserver.yaml"]

  coturn:
    image: coturn/coturn:latest
    container_name: coturn
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      # Large UDP port range removed for Windows compatibility
      # On Linux, you can uncomment the line below if needed:
      # - "49152-65535:49152-65535/udp"
    volumes:
      - ./coturn/turnserver.conf:/etc/turnserver.conf:ro
    environment:
      - TURN_USERNAME=${TURN_USERNAME:-turnuser}
      - TURN_PASSWORD=${TURN_PASSWORD:-turnpass}
      - TURN_SHARED_SECRET=${TURN_SHARED_SECRET:-2OzimVpRm5Jani7NM8VsqZpaP6rrUjZeZs8LBj1ud-4}
      - TURN_REALM=${TURN_REALM:-localhost}
    restart: unless-stopped
    # network_mode: "host" removed - not supported on Windows Docker
    # Use bridge networking (default) for cross-platform compatibility

volumes:
  pgdata:
  synapse_data:
  synapse_db_data:

